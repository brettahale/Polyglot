

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>polyglot.nodeserver_api &mdash; Polyglot 0.0.6 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="Polyglot 0.0.6 documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> Polyglot
          

          
          </a>

          
            
            
              <div class="version">
                0.0.6
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nsdev.html">Node Server Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nsexample.html">Python Node Server Example</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nsapi.html">Polyglot Node Server API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../module.html">Polyglot Methods and Classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../optional.html">Optional Components</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog.html">Changelog</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">Polyglot</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../index.html">Module code</a> &raquo;</li>
      
    <li>polyglot.nodeserver_api</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for polyglot.nodeserver_api</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This library consists of four classes and one function to assist with node</span>
<span class="sd">server development. The classes :class:`polyglot.nodeserver_api.NodeServer` and</span>
<span class="sd">:class:`polyglot.nodeserver_api.SimpleNodeServer` and basic structures for</span>
<span class="sd">creating a node server. The class :class:`polyglot.nodeserver_api.Node` is</span>
<span class="sd">used as an abstract class to crate custom nodes for node servers.  The class</span>
<span class="sd">:class:`polyglot.nodeserver_api.PolyglotConnector` is a bottom level</span>
<span class="sd">implementation of the API used to communicate between Polyglot and your</span>
<span class="sd">node server. Finally, included in this library is a method decorator,</span>
<span class="sd">:meth:`polyglot.nodeserver_api.auto_request_report`, that wraps functions and</span>
<span class="sd">methods to automatically handle report requests from the ISY.</span>

<span class="sd">.. decorator: PolyglotConnector</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span><span class="p">,</span> <span class="n">OrderedDict</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">logging.handlers</span>
<span class="kn">from</span> <span class="nn">polyglot.utils</span> <span class="kn">import</span> <span class="n">AsyncFileReader</span><span class="p">,</span> <span class="n">Empty</span><span class="p">,</span> <span class="n">LockQueue</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">xml.etree.ElementTree</span> <span class="kn">as</span> <span class="nn">ET</span>

<span class="c1"># Updated for YAML nodeserver config file (E.42) - for backwards compat</span>
<span class="n">YAML</span> <span class="o">=</span> <span class="bp">True</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">yaml</span>
<span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="n">YAML</span> <span class="o">=</span> <span class="bp">False</span>

<span class="c1"># Increment this version number each time a breaking change is made to</span>
<span class="c1"># anything that the nodeserver API exposes to a node server.  This makes</span>
<span class="c1"># it possible for the author of a node server to write code that can</span>
<span class="c1"># support multiple possibly-incompatible Polyglot servers.  This is</span>
<span class="c1"># important because node servers will often be distributed independently</span>
<span class="c1"># of Polyglot, and the authors of the node servers may have little to</span>
<span class="c1"># no control over what version of Polyglot the end user is running.</span>
<span class="n">NS_API_VERSION</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">_POLYGLOT_CONNECTION</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">OUTPUT_DELAY</span> <span class="o">=</span> <span class="mi">0</span>

<div class="viewcode-block" id="auto_request_report"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.auto_request_report">[docs]</a><span class="k">def</span> <span class="nf">auto_request_report</span><span class="p">(</span><span class="n">fun</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Python decorator to automate request reporting. Decorated functions must</span>
<span class="sd">    return a boolean value indicating their success or failure. It the</span>
<span class="sd">    argument *request_id* is passed to the decorated function, a response will</span>
<span class="sd">    be sent to the ISY. This decorator is implemented in the SimpleNodeServer.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">fun</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">auto_request_report_wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handler function wrapper to automatically report request status to ISY</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">request_id</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;request_id&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">success</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">request_id</span> <span class="ow">and</span> <span class="n">_POLYGLOT_CONNECTION</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">_POLYGLOT_CONNECTION</span><span class="o">.</span><span class="n">report_request_status</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span>
                                                       <span class="nb">bool</span><span class="p">(</span><span class="n">success</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">success</span>
    <span class="k">return</span> <span class="n">auto_request_report_wrapper</span>

</div>
<div class="viewcode-block" id="Node"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.Node">[docs]</a><span class="k">class</span> <span class="nc">Node</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Abstract class for representing a node in a node server.</span>

<span class="sd">    :param parent: The node server that controls the node</span>
<span class="sd">    :type parent: polyglot.nodeserver_api.NodeServer</span>
<span class="sd">    :param str address: The address of the node in the ISY without the node</span>
<span class="sd">                        server ID prefix</span>
<span class="sd">    :param str name: The name of the node</span>
<span class="sd">    :param primary: The primary node for the device this node belongs to, </span>
<span class="sd">                        or True if it&#39;s the primary.</span>
<span class="sd">    :type primary: polyglot.nodeserver_api.Node or True if this node is the primary.</span>
<span class="sd">    :param manifest: The node manifest saved by the node server</span>
<span class="sd">    :type manifest: dict or None</span>

<span class="sd">    .. document private methods</span>
<span class="sd">    .. autoattribute:: _drivers</span>
<span class="sd">    .. autoattribute:: _commands</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">primary</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">manifest</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; update driver values from manifest &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">poly</span><span class="o">.</span><span class="n">logger</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">address</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">primary</span> <span class="o">=</span> <span class="n">primary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_drivers</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_drivers</span><span class="p">)</span>
        <span class="n">manifest</span> <span class="o">=</span> <span class="n">manifest</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="p">{})</span> <span class="k">if</span> <span class="n">manifest</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="n">new_node</span> <span class="o">=</span> <span class="n">manifest</span> <span class="o">==</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="s1">&#39;_is_node_server&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Error: node &quot;</span><span class="si">%s</span><span class="s1">&quot;, parent &quot;</span><span class="si">%s</span><span class="s1">&quot; is not a NodeServer.&#39;</span>
                               <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">parent</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">added</span> <span class="o">=</span> <span class="n">manifest</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;added&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="n">manifest</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;enabled&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">manifest</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">probe_t</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">drivers</span> <span class="o">=</span> <span class="n">manifest</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;drivers&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_drivers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_drivers</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">drivers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">smsg</span><span class="p">(</span>
            <span class="s1">&#39;**INFO: Node initialized: addr=&quot;{}&quot; name=&quot;{}&quot; added={} enabled={}&#39;</span>
            <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">added</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">enabled</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_node</span><span class="p">()</span>


<div class="viewcode-block" id="Node.smsg"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.Node.smsg">[docs]</a>    <span class="k">def</span> <span class="nf">smsg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Logs/sends a diagnostic/debug, informative, or error message.</span>
<span class="sd">        Individual node servers can override this method if they desire to</span>
<span class="sd">        redirect or filter these messages.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">smsg</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Node.run_cmd"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.Node.run_cmd">[docs]</a>    <span class="k">def</span> <span class="nf">run_cmd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs one of the node&#39;s commands.</span>

<span class="sd">        :param str command: The name of the command</span>
<span class="sd">        :param dict kwargs: The parameters specified by the ISY in the</span>
<span class="sd">                            incoming request. See the ISY Node Server</span>
<span class="sd">                            documentation for more information.</span>
<span class="sd">        :returns boolean: Indicates success or failure of command</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">command</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_commands</span><span class="p">:</span>
            <span class="n">fun</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_commands</span><span class="p">[</span><span class="n">command</span><span class="p">]</span>
            <span class="n">success</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">success</span>
        <span class="k">return</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="Node.set_driver"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.Node.set_driver">[docs]</a>    <span class="k">def</span> <span class="nf">set_driver</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">driver</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">uom</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">report</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates the value of one of the node&#39;s drivers. This will pass the</span>
<span class="sd">        given value through the driver&#39;s formatter before assignment.</span>

<span class="sd">        :param str driver: The name of the driver</span>
<span class="sd">        :param value: The new value for the driver</span>
<span class="sd">        :param uom: The given values unit of measurement. This should</span>
<span class="sd">                    correspond to the UOM IDs used by the ISY. Refer to the ISY</span>
<span class="sd">                    documentation for more information.</span>
<span class="sd">        :type uom: int or None</span>
<span class="sd">        :param boolean report: Indicates if the value change should be reported</span>
<span class="sd">                               to the ISY. If False, the value is changed</span>
<span class="sd">                               silently.</span>
<span class="sd">        :returns boolean: Indicates success or failure to set new value</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># pylint: disable=unused-argument</span>
        <span class="k">if</span> <span class="n">driver</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_drivers</span><span class="p">:</span>
            <span class="n">clean_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_drivers</span><span class="p">[</span><span class="n">driver</span><span class="p">][</span><span class="mi">2</span><span class="p">](</span><span class="n">value</span><span class="p">)</span>
            <span class="n">changed</span> <span class="o">=</span> <span class="p">(</span><span class="n">clean_value</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_drivers</span><span class="p">[</span><span class="n">driver</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">in_sync</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isy_synced</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">driver</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">changed</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">in_sync</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_drivers</span><span class="p">[</span><span class="n">driver</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">clean_value</span>
                <span class="k">if</span> <span class="n">report</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_isy_synced</span><span class="p">[</span><span class="n">driver</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">report_driver</span><span class="p">(</span><span class="n">driver</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_isy_synced</span><span class="p">[</span><span class="n">driver</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smsg</span><span class="p">(</span><span class="s1">&#39;**ERROR: node &quot;{}&quot;: set_driver(): invalid driver &quot;{}&quot;&#39;</span>
                  <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">driver</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="Node.report_driver"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.Node.report_driver">[docs]</a>    <span class="k">def</span> <span class="nf">report_driver</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reports a driver&#39;s current value to ISY</span>

<span class="sd">        :param driver: The name of the driver to report. If None, all drivers</span>
<span class="sd">                       are reported.</span>
<span class="sd">        :type driver: str or None</span>
<span class="sd">        :returns boolean: Indicates success or failure to report driver value</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">enabled</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">added</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>

        <span class="k">if</span> <span class="n">driver</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">drivers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_drivers</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">drivers</span> <span class="o">=</span> <span class="p">[</span><span class="n">driver</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">driver</span> <span class="ow">in</span> <span class="n">drivers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">report_status</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="n">driver</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_drivers</span><span class="p">[</span><span class="n">driver</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_drivers</span><span class="p">[</span><span class="n">driver</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_report_driver_cb</span><span class="p">,</span>
                <span class="bp">None</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="n">driver</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="Node._report_driver_cb"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.Node._report_driver_cb">[docs]</a>    <span class="k">def</span> <span class="nf">_report_driver_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">driver</span><span class="p">,</span> <span class="n">status_code</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Private method - updates ISY syncronization flag based on</span>
<span class="sd">        the success/fail of the status update API call to the ISY.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">driver</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_drivers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">smsg</span><span class="p">(</span>
                <span class="s1">&#39;**ERROR: node &quot;{}&quot;: driver &quot;{}&quot;: no longer exists.&#39;</span>
                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">driver</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">status_code</span><span class="p">)</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_isy_synced</span><span class="p">[</span><span class="n">driver</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">smsg</span><span class="p">(</span>
                <span class="s1">&#39;**DEBUG: node &quot;{}&quot;: driver &quot;{}&quot;: status sent to ISY ok.&#39;</span>
                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">driver</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_isy_synced</span><span class="p">[</span><span class="n">driver</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">smsg</span><span class="p">(</span>
                <span class="s1">&#39;**ERROR: node &quot;{}&quot;: driver &quot;{}&quot;: unable to report status to ISY: {}&#39;</span>
                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">driver</span><span class="p">,</span> <span class="n">status_code</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="Node.get_driver"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.Node.get_driver">[docs]</a>    <span class="k">def</span> <span class="nf">get_driver</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets a driver&#39;s value</span>

<span class="sd">        :param driver: The driver to return the value for</span>
<span class="sd">        :type driver: str or None</span>
<span class="sd">        :returns: The current value of the driver</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">driver</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_drivers</span><span class="p">[</span><span class="n">driver</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_drivers</span>
</div>
<div class="viewcode-block" id="Node.query"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.Node.query">[docs]</a>    <span class="k">def</span> <span class="nf">query</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Abstractly queries the node. This method should generally be</span>
<span class="sd">        overwritten in development.</span>

<span class="sd">        :returns boolean: Indicates success or failure of node query</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">report_driver</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="Node.add_node"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.Node.add_node">[docs]</a>    <span class="k">def</span> <span class="nf">add_node</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds node to the ISY</span>

<span class="sd">        :returns boolean: Indicates success or failure of node addition</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">14</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">smsg</span><span class="p">(</span>
                <span class="s1">&#39;**ERROR: name too long (&gt;14), will fail when adding on ISY): &quot;{}&quot;&#39;</span>
                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smsg</span><span class="p">(</span><span class="s1">&#39;**DEBUG: node &quot;</span><span class="si">%s</span><span class="s1">&quot;: parent=&quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">report_driver</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="Node.report_isycmd"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.Node.report_isycmd">[docs]</a>    <span class="k">def</span> <span class="nf">report_isycmd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">isycommand</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">uom</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                      <span class="n">timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sends a single command from the node server to the ISY, optionally</span>
<span class="sd">        passing in a value.</span>

<span class="sd">        No formatting, and little validation, of the isy cmd, value, or uom</span>
<span class="sd">        is done by this simple low-level API.  It is up to the caller to</span>
<span class="sd">        ensure correctness.</span>

<span class="sd">        :param str isycommand: Name of the ISY command to send (e.g. &#39;DON&#39;)</span>
<span class="sd">        :param value: (optional) The value to be sent for the command</span>
<span class="sd">        :type value: string, float, int, or None</span>
<span class="sd">        :param uom: (optional) - The value&#39;s unit of measurement.  If</span>
<span class="sd">                    provided, overrides the uom defined for this command</span>
<span class="sd">        :type uom: int or None</span>
<span class="sd">        :param timeout: (optional) - the number of seconds before this</span>
<span class="sd">                        command expires and is discarded</span>
<span class="sd">        :type timeout: int or None</span>
<span class="sd">        :returns boolean: Indicates success or failure to queue for sending</span>
<span class="sd">                          (Note: does NOT indicate if actually delivered)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Test for a valid defined command</span>
        <span class="k">if</span> <span class="n">isycommand</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sends</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">smsg</span><span class="p">(</span>
                <span class="s1">&#39;**ERROR: node &quot;{}&quot;: report_isycmd(): unknown ISY command &quot;{}&quot;&#39;</span>
                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">isycommand</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">u</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Value is provided - make sure we have a uom</span>
            <span class="k">if</span> <span class="n">uom</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sends</span><span class="p">[</span><span class="n">isycommand</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">u</span> <span class="o">=</span> <span class="n">uom</span>
            <span class="c1"># Convert/clean the value if such a function was defined</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sends</span><span class="p">[</span><span class="n">isycommand</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sends</span><span class="p">[</span><span class="n">isycommand</span><span class="p">][</span><span class="mi">2</span><span class="p">](</span><span class="n">value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">value</span>
        <span class="c1"># Save the value and uom we&#39;re sending, for reference</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sends</span><span class="p">[</span><span class="n">isycommand</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sends</span><span class="p">[</span><span class="n">isycommand</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span>
        <span class="c1"># Issue the command itself</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">poly</span><span class="o">.</span><span class="n">report_command</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="n">isycommand</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># TODO: test/document extended ISY command API:</span>
        <span class="c1">#           extras = {&#39;GV1.uom56&#39;: int(gv1_value)}</span>
        <span class="c1">#           node.report_isycmd(&#39;DON&#39;, **extras)</span>
        <span class="c1"># TODO: callback for timeout/error handling -- but first</span>
        <span class="c1">#       need to define desired behavior in such cases</span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">manifest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The node&#39;s manifest entry. Indicates the current value of each of the</span>
<span class="sd">        drivers. This is called by the node server to create the full manifest.</span>

<span class="sd">        :type: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">manifest</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="s1">&#39;added&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">added</span><span class="p">,</span>
                    <span class="s1">&#39;enabled&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">enabled</span><span class="p">,</span>
                    <span class="s1">&#39;node_def_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_def_id</span><span class="p">,</span>
                    <span class="s1">&#39;drivers&#39;</span><span class="p">:</span> <span class="p">{}}</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_drivers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="ow">or</span> <span class="n">val</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">manifest</span><span class="p">[</span><span class="s1">&#39;drivers&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">manifest</span>


    <span class="n">_isy_synced</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Internal dictionary containing the synchronization status of this</span>
<span class="sd">    driver with the ISY.  Used to eliminate unnecessary status updates.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_drivers</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The drivers controlled by this node. This is a dictionary of lists. The</span>
<span class="sd">    key&#39;s are the driver names as defined by the ISY documentation. Each list</span>
<span class="sd">    contains at least three values: the initial value, the UOM identifier, and</span>
<span class="sd">    a function that will properly format the value before assignment.  The</span>
<span class="sd">    fourth value is optional -- if provided, and set to &quot;False&quot;, the driver&#39;s</span>
<span class="sd">    value will not be recorded in the manifest (this is useful to reduce I/O</span>
<span class="sd">    when there is no benefit to restoring the driver&#39;s value on restart).</span>

<span class="sd">    *Insteon Dimmer Example:*</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        _drivers = {</span>
<span class="sd">            &#39;ST&#39;: [0, 51, int],</span>
<span class="sd">            &#39;OL&#39;: [100, 51, int],</span>
<span class="sd">            &#39;RR&#39;: [0, 32, int]</span>
<span class="sd">        }</span>

<span class="sd">    *Pulse Time Example:*</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        _drivers = {</span>
<span class="sd">            &#39;ST&#39;: [0, 56, int, False],</span>
<span class="sd">        }</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_sends</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A dictionary of the commands that this node sends to the ISY. The</span>
<span class="sd">    keys are the command names to be sent to the ISY. Each list contains</span>
<span class="sd">    at least three values: the last command value sent to the ISY, the</span>
<span class="sd">    UOM identifier for that command, and a function that will properly</span>
<span class="sd">    format the value before sending it.  If the command will never send</span>
<span class="sd">    a value (e.g. &#39;DOF&#39;), setting all three to None is appropriate.</span>

<span class="sd">    *Simple Dimmer Switch Example:*</span>

<span class="sd">    .. code-block:: python</span>
<span class="sd">        _sends = {</span>
<span class="sd">            &#39;DON&#39;: [0, 51, int],</span>
<span class="sd">            &#39;DOF&#39;: [None, None, None]</span>
<span class="sd">        }</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_commands</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A dictionary of the commands that the node can perform. The keys of this</span>
<span class="sd">    dictionary are the names of the command. The values are functions that must</span>
<span class="sd">    be defined in the node object that perform the necessary actions and return</span>
<span class="sd">    a boolean indicating the success or failure of the command.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">node_def_id</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="sd">&quot;&quot;&quot; The node&#39;s definition ID defined in the node server&#39;s profile &quot;&quot;&quot;</span>

</div>
<div class="viewcode-block" id="NodeServer"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.NodeServer">[docs]</a><span class="k">class</span> <span class="nc">NodeServer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    It is generally desireable to not be required to bind to each event. For</span>
<span class="sd">    this reason, the NodeServer abstract class is available. This class should</span>
<span class="sd">    be abstracted. It binds appropriate handlers to the API events and contains</span>
<span class="sd">    a suitable run loop. It should serve as a basic structure for any node</span>
<span class="sd">    server.</span>

<span class="sd">    :param poly: The connected Polyglot connection</span>
<span class="sd">    :type poly: polyglot.nodeserver_api.PolyglotConnector</span>
<span class="sd">    :param int optional shortpoll: The seconds between poll events</span>
<span class="sd">    :param int optional longpoll: The second between longpoll events</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># pylint: disable=unused-argument</span>

    <span class="n">poly</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The Polyglot Connection</span>

<span class="sd">    :type: polyglot.nodeserver_api.PolyglotConnector</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">poly</span><span class="p">,</span> <span class="n">shortpoll</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">longpoll</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
        <span class="c1"># create/store properties</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">poly</span> <span class="o">=</span> <span class="n">poly</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shortpoll</span> <span class="o">=</span> <span class="n">shortpoll</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">longpoll</span> <span class="o">=</span> <span class="n">longpoll</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_node_server</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_seq</span> <span class="o">=</span> <span class="mi">1000</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_seq_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_seq_cb</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># bind callbacks to events</span>
        <span class="n">poly</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="s1">&#39;config&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_config</span><span class="p">)</span>
        <span class="n">poly</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="s1">&#39;install&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_install</span><span class="p">)</span>
        <span class="n">poly</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="s1">&#39;query&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_query</span><span class="p">)</span>
        <span class="n">poly</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_status</span><span class="p">)</span>
        <span class="n">poly</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="s1">&#39;add_all&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_add_all</span><span class="p">)</span>
        <span class="n">poly</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="s1">&#39;added&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_added</span><span class="p">)</span>
        <span class="n">poly</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="s1">&#39;removed&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_removed</span><span class="p">)</span>
        <span class="n">poly</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="s1">&#39;renamed&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_renamed</span><span class="p">)</span>
        <span class="n">poly</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="s1">&#39;enabled&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_enabled</span><span class="p">)</span>
        <span class="n">poly</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="s1">&#39;disabled&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_disabled</span><span class="p">)</span>
        <span class="n">poly</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="s1">&#39;cmd&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_cmd</span><span class="p">)</span>
        <span class="n">poly</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="s1">&#39;exit&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_exit</span><span class="p">)</span>
        <span class="n">poly</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="s1">&#39;result&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_result</span><span class="p">)</span>
        <span class="n">poly</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="s1">&#39;statistics&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_statistics</span><span class="p">)</span>

<div class="viewcode-block" id="NodeServer.setup"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.NodeServer.setup">[docs]</a>    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Setup the node server.  All node servers must override this method and </span>
<span class="sd">        call it thru super.</span>
<span class="sd">        Currently it only sets up the reference for the logger.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">poly</span><span class="o">.</span><span class="n">logger</span>
        </div>
<div class="viewcode-block" id="NodeServer.smsg"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.NodeServer.smsg">[docs]</a>    <span class="k">def</span> <span class="nf">smsg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Logs/sends a diagnostic/debug, informative, or error message.</span>
<span class="sd">        Individual node servers can override this method if they desire to</span>
<span class="sd">        redirect or filter these messages.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">poly</span><span class="o">.</span><span class="n">send_error</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="NodeServer.on_config"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.NodeServer.on_config">[docs]</a>    <span class="k">def</span> <span class="nf">on_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Received configuration data from Polyglot</span>

<span class="sd">        :param dict data: Configuration data</span>
<span class="sd">        :returns bool: True on success</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">data</span>
        <span class="k">return</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="NodeServer.on_install"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.NodeServer.on_install">[docs]</a>    <span class="k">def</span> <span class="nf">on_install</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">profile_number</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Received install command from ISY</span>

<span class="sd">        :param int profile_number: Noder Server&#39;s profile number</span>
<span class="sd">        :returns bool: True on success</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># pylint: disable=no-self-use</span>
        <span class="k">return</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="NodeServer.on_query"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.NodeServer.on_query">[docs]</a>    <span class="k">def</span> <span class="nf">on_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_address</span><span class="p">,</span> <span class="n">request_id</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Received query command from ISY</span>

<span class="sd">        :param str node_address: The address of the node to act on</span>
<span class="sd">        :param str optional request_id: Status request id</span>
<span class="sd">        :returns bool: True on success</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># pylint: disable=no-self-use</span>
        <span class="k">return</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="NodeServer.on_status"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.NodeServer.on_status">[docs]</a>    <span class="k">def</span> <span class="nf">on_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_address</span><span class="p">,</span> <span class="n">request_id</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Received status command from ISY</span>

<span class="sd">        :param str node_address: The address of the node to act on</span>
<span class="sd">        :param str optional request_id: Status request id</span>
<span class="sd">        :returns bool: True on success</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># pylint: disable=no-self-use</span>
        <span class="k">return</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="NodeServer.on_add_all"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.NodeServer.on_add_all">[docs]</a>    <span class="k">def</span> <span class="nf">on_add_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request_id</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Received add all command from ISY</span>

<span class="sd">        :param str optional request_id: Status request id</span>
<span class="sd">        :returns bool: True on success</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># pylint: disable=no-self-use</span>
        <span class="k">return</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="NodeServer.on_added"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.NodeServer.on_added">[docs]</a>    <span class="k">def</span> <span class="nf">on_added</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_address</span><span class="p">,</span> <span class="n">node_def_id</span><span class="p">,</span> <span class="n">primary_node_address</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Received node added report from ISY</span>

<span class="sd">        :param str node_address: The address of the node to act on</span>
<span class="sd">        :param str node_def_id: The node definition id</span>
<span class="sd">        :param str primary_node_address: The node server&#39;s primary node address</span>
<span class="sd">        :param str name: The node&#39;s friendly name</span>
<span class="sd">        :param str optional request_id: Status request id</span>
<span class="sd">        :returns bool: True on success</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># pylint: disable=no-self-use</span>
        <span class="k">return</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="NodeServer.on_removed"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.NodeServer.on_removed">[docs]</a>    <span class="k">def</span> <span class="nf">on_removed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_address</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Received node removed report from ISY</span>

<span class="sd">        :param str node_address: The address of the node to act on</span>
<span class="sd">        :returns bool: True on success</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># pylint: disable=no-self-use</span>
        <span class="k">return</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="NodeServer.on_renamed"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.NodeServer.on_renamed">[docs]</a>    <span class="k">def</span> <span class="nf">on_renamed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_address</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Received node renamed report from ISY</span>

<span class="sd">        :param str node_address: The address of the node to act on</span>
<span class="sd">        :param str name: The node&#39;s friendly name</span>
<span class="sd">        :returns bool: True on success</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># pylint: disable=no-self-use</span>
        <span class="k">return</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="NodeServer.on_enabled"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.NodeServer.on_enabled">[docs]</a>    <span class="k">def</span> <span class="nf">on_enabled</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_address</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Received node enabled report from ISY</span>

<span class="sd">        :param str node_address: The address of the node to act on</span>
<span class="sd">        :returns bool: True on success</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># pylint: disable=no-self-use</span>
        <span class="k">return</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="NodeServer.on_disabled"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.NodeServer.on_disabled">[docs]</a>    <span class="k">def</span> <span class="nf">on_disabled</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_address</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Received node disabled report from ISY</span>

<span class="sd">        :param str node_address: The address of the node to act on</span>
<span class="sd">        :returns bool: True on success</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># pylint: disable=no-self-use</span>
        <span class="k">return</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="NodeServer.on_cmd"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.NodeServer.on_cmd">[docs]</a>    <span class="k">def</span> <span class="nf">on_cmd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_address</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">uom</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
               <span class="n">request_id</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Received run command from ISY</span>

<span class="sd">        :param str node_address: The address of the node to act on</span>
<span class="sd">        :param str command: The command to run</span>
<span class="sd">        :param optional value: The value of the command&#39;s unnamed parameter</span>
<span class="sd">        :param optional uom: The units of measurement for the unnamed parameter</span>
<span class="sd">        :param str optional request_id: Status request id</span>
<span class="sd">        :param optional &lt;pN&gt;.&lt;uomN&gt;: The value of parameter pN with units uomN</span>
<span class="sd">        :returns bool: True on success</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># pylint: disable=no-self-use</span>
        <span class="k">return</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="NodeServer.on_statistics"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.NodeServer.on_statistics">[docs]</a>    <span class="k">def</span> <span class="nf">on_statistics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handles a statistics message, which contains various statistics on</span>
<span class="sd">        the operation of the Polyglot server and the network communications.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># pylint: disable=no-self-use</span>
        <span class="k">return</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="NodeServer.on_exit"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.NodeServer.on_exit">[docs]</a>    <span class="k">def</span> <span class="nf">on_exit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Polyglot has triggered a clean shutdown. Generally, this method does</span>
<span class="sd">        not need to be orwritten.</span>

<span class="sd">        :returns bool: True on success</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="NodeServer.on_result"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.NodeServer.on_result">[docs]</a>    <span class="k">def</span> <span class="nf">on_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">status_code</span><span class="p">,</span> <span class="n">elapsed</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">retries</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handles a result message, which contains the result from a REST API</span>
<span class="sd">        call to the ISY.  The result message is uniquely identified by the</span>
<span class="sd">        seq id, and will always contain at least the numeric status.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">seq</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_seq_cb</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">smsg</span><span class="p">(</span><span class="s1">&#39;**ERROR: on_result: missing callback for seq={}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">seq</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="n">func</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_seq_cb</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="n">seq</span><span class="o">=</span><span class="n">seq</span><span class="p">,</span> <span class="n">status_code</span><span class="o">=</span><span class="n">status_code</span><span class="p">,</span> <span class="n">elapsed</span><span class="o">=</span><span class="n">elapsed</span><span class="p">,</span>
                    <span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">,</span> <span class="n">retries</span><span class="o">=</span><span class="n">retries</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="NodeServer.register_result_cb"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.NodeServer.register_result_cb">[docs]</a>    <span class="k">def</span> <span class="nf">register_result_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Registers a callback function to handle a result.</span>
<span class="sd">        Returns the unique sequence ID to be passed to the function whose</span>
<span class="sd">        result is to be handled by the registered callback.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_seq_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_seq</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_seq</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_seq_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_seq_cb</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">func</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">s</span>
</div>
<div class="viewcode-block" id="NodeServer.add_node"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.NodeServer.add_node">[docs]</a>    <span class="k">def</span> <span class="nf">add_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_address</span><span class="p">,</span> <span class="n">node_def_id</span><span class="p">,</span> <span class="n">node_primary_addr</span><span class="p">,</span>
                 <span class="n">node_name</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add this node to the polyglot</span>

<span class="sd">        :returns bool: True on success</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">seq</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">callback</span><span class="p">:</span>
            <span class="n">seq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register_result_cb</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">poly</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">node_address</span><span class="p">,</span> <span class="n">node_def_id</span><span class="p">,</span> <span class="n">node_primary_addr</span><span class="p">,</span>
                           <span class="n">node_name</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">seq</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="NodeServer.report_status"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.NodeServer.report_status">[docs]</a>    <span class="k">def</span> <span class="nf">report_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_address</span><span class="p">,</span> <span class="n">driver_control</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">uom</span><span class="p">,</span>
                      <span class="n">callback</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Report a node status to the ISY</span>

<span class="sd">        :returns bool: True on success</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">seq</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">callback</span><span class="p">:</span>
            <span class="n">seq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register_result_cb</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">poly</span><span class="o">.</span><span class="n">report_status</span><span class="p">(</span><span class="n">node_address</span><span class="p">,</span> <span class="n">driver_control</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">uom</span><span class="p">,</span>
                                <span class="n">timeout</span><span class="p">,</span> <span class="n">seq</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="NodeServer.restcall"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.NodeServer.restcall">[docs]</a>    <span class="k">def</span> <span class="nf">restcall</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">api</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sends an asynchronous REST API call to the ISY.</span>
<span class="sd">        Returns the unique seq id (that can be used to match up the result</span>
<span class="sd">        later on after the REST call completes).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">callback</span><span class="p">:</span>
            <span class="n">seq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register_result_cb</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">poly</span><span class="o">.</span><span class="n">restcall</span><span class="p">(</span><span class="n">api</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">seq</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">seq</span>
</div>
<div class="viewcode-block" id="NodeServer.tock"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.NodeServer.tock">[docs]</a>    <span class="k">def</span> <span class="nf">tock</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Called every few seconds for internal housekeeping. &quot;&quot;&quot;</span>
        <span class="c1"># pylint: disable=no-self-use</span>
        <span class="k">pass</span>
</div>
<div class="viewcode-block" id="NodeServer.poll"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.NodeServer.poll">[docs]</a>    <span class="k">def</span> <span class="nf">poll</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Called every shortpoll seconds to allow for updating nodes. &quot;&quot;&quot;</span>
        <span class="c1"># pylint: disable=no-self-use</span>
        <span class="k">pass</span>
</div>
<div class="viewcode-block" id="NodeServer.long_poll"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.NodeServer.long_poll">[docs]</a>    <span class="k">def</span> <span class="nf">long_poll</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Called every longpoll seconds for less important polling. &quot;&quot;&quot;</span>
        <span class="c1"># pylint: disable=no-self-use</span>
        <span class="k">pass</span>
        </div>
<div class="viewcode-block" id="NodeServer.run"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.NodeServer.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run the Node Server. Exit when triggered. Generally, this method should</span>
<span class="sd">        not be overwritten.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">poly</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
        <span class="n">scounter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">lcounter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">tcounter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">scounter</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">lcounter</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">tcounter</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="k">if</span> <span class="n">scounter</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shortpoll</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span>
                    <span class="n">scounter</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="k">if</span> <span class="n">lcounter</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">longpoll</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">long_poll</span><span class="p">()</span>
                    <span class="n">lcounter</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="k">if</span> <span class="n">tcounter</span> <span class="o">&gt;=</span> <span class="mi">7</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tock</span><span class="p">()</span>
                    <span class="n">tcounter</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">on_exit</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">poly</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

</div></div>
<div class="viewcode-block" id="SimpleNodeServer"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.SimpleNodeServer">[docs]</a><span class="k">class</span> <span class="nc">SimpleNodeServer</span><span class="p">(</span><span class="n">NodeServer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simple Node Server with basic functionality built-in. This class inherits</span>
<span class="sd">    from :class:`polyglot.nodeserver_api.NodeServer` and is the best starting</span>
<span class="sd">    point when developing a new node server. This class implements the idea of</span>
<span class="sd">    manifests which are dictionaries that contain the relevant information</span>
<span class="sd">    about all of the nodes. The manifest gets sent to Polyglot to be saved as</span>
<span class="sd">    part of the configuration. This allows the node server to automatically</span>
<span class="sd">    recall its last known values when it is restarted.</span>

<span class="sd">    .. decorated</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_rest_response</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">nodes</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Nodes registered with this node server.  All nodes are automatically added</span>
<span class="sd">    by the add_node method.  The keys are the node IDs while the values are </span>
<span class="sd">    instances of :class:`polyglot.nodeserver_api.Node`. Classes inheriting</span>
<span class="sd">    can access this directly, but the prefered method is by using get_node or</span>
<span class="sd">    exist_node methods.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nd">@auto_request_report</span>
<div class="viewcode-block" id="SimpleNodeServer.add_node"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.SimpleNodeServer.add_node">[docs]</a>    <span class="k">def</span> <span class="nf">add_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add node to the Polyglot and the nodes dictionary.</span>

<span class="sd">        :param node: The node to add</span>
<span class="sd">        :type node: polyglot.nodeserver_api.Node</span>
<span class="sd">        :returns boolean: Indicates success or failure of node addition</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">na</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">address</span>
        <span class="k">if</span> <span class="n">na</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">na</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">na</span><span class="p">]</span><span class="o">.</span><span class="n">added</span><span class="p">:</span>
            <span class="c1"># By default the primary_address is its own address...</span>
            <span class="n">primary_addr</span> <span class="o">=</span> <span class="n">na</span>
            <span class="c1"># ...unless a node was passed in as the primary.</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">primary</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">True</span><span class="p">:</span>
                <span class="c1"># A primary node must be its own primary because ISY only</span>
                <span class="c1"># supports one level deep.</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">primary</span><span class="o">.</span><span class="n">primary</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Error: node &quot;</span><span class="si">%s</span><span class="s1">&quot;, primary &quot;</span><span class="si">%s</span><span class="s1">&quot; is not primary.&#39;</span>
                                       <span class="o">%</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">primary</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                <span class="n">primary_addr</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">primary</span><span class="o">.</span><span class="n">address</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">smsg</span><span class="p">(</span><span class="s1">&#39;**DEBUG: add_node: na=&quot;{}&quot;, id=&quot;{}&quot;, pa=&quot;{}&quot;, nm=&quot;{}&quot;&#39;</span>
                      <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">na</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">node_def_id</span><span class="p">,</span> <span class="n">primary_addr</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">SimpleNodeServer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">na</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">node_def_id</span><span class="p">,</span>
                                                   <span class="n">primary_addr</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                                   <span class="bp">self</span><span class="o">.</span><span class="n">_add_node_cb</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span>
                                                   <span class="n">na</span><span class="o">=</span><span class="n">na</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">True</span>
</div>
    <span class="k">def</span> <span class="nf">tock</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">all_nodes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_nodes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
            <span class="n">next_t</span> <span class="o">=</span> <span class="n">t</span> <span class="o">+</span> <span class="mi">600</span> <span class="o">+</span> <span class="p">(</span><span class="mi">7</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">poly</span><span class="o">.</span><span class="n">profile</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">next_t</span> <span class="o">+=</span> <span class="mi">7</span>
                <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">probe_t</span> <span class="o">&lt;</span> <span class="n">t</span><span class="p">:</span>
                    <span class="c1"># Request the check - sends rest api call</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">request_node_probe</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>
                    <span class="c1"># Mark node for next check</span>
                    <span class="n">node</span><span class="o">.</span><span class="n">probe_t</span> <span class="o">=</span> <span class="n">next_t</span>
        <span class="c1"># [TODO] extend probe for unknown nodes</span>
        <span class="k">return</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">request_node_probe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_address</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">pfx</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">poly</span><span class="o">.</span><span class="n">profile</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">full_addr</span> <span class="o">=</span> <span class="s1">&#39;n{}_{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pfx</span><span class="p">,</span> <span class="n">node_address</span><span class="p">)</span>
        <span class="n">api</span> <span class="o">=</span> <span class="s1">&#39;nodes/&#39;</span> <span class="o">+</span> <span class="n">full_addr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smsg</span><span class="p">(</span><span class="s1">&#39;**DEBUG: request_node_probe: na=&quot;{}&quot; fa=&quot;{}&quot; api=&quot;{}&quot;&#39;</span>
                  <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">node_address</span><span class="p">,</span> <span class="n">full_addr</span><span class="p">,</span> <span class="n">api</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">SimpleNodeServer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">restcall</span><span class="p">(</span>
            <span class="n">api</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_probe_response</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">na</span><span class="o">=</span><span class="n">node_address</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">node_probe_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status_code</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">na</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">smsg</span><span class="p">(</span><span class="s1">&#39;**DEBUG: probe: st={} na=&quot;{}&quot; text: {}&#39;</span>
                  <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">status_code</span><span class="p">,</span> <span class="n">na</span><span class="p">,</span> <span class="n">text</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">na</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
            <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">na</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">smsg</span><span class="p">(</span><span class="s1">&#39;**ERROR: probe: node &quot;{}&quot; does not exist&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">na</span><span class="p">))</span>
            <span class="c1"># No action practical for this problem</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">smsg</span><span class="p">(</span><span class="s1">&#39;**WARNING: probe: status code: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">status_code</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">status_code</span> <span class="o">==</span> <span class="mi">404</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">added</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">smsg</span><span class="p">(</span><span class="s1">&#39;**WARNING: probe: na=&quot;{}&quot;: state mismatch&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">na</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">smsg</span><span class="p">(</span><span class="s1">&#39;**WARNING: probe: ISY does not think this node exists&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">smsg</span><span class="p">(</span><span class="s1">&#39;**WARNING: probe: Correcting local node state&#39;</span><span class="p">)</span>
                <span class="n">node</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="n">node</span><span class="o">.</span><span class="n">added</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">return</span> <span class="bp">True</span>

        <span class="c1"># Parse the XML response text from the ISY</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">root</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ET</span><span class="o">.</span><span class="n">ParseError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">smsg</span><span class="p">(</span><span class="s1">&#39;**ERROR: probe: Unable to parse ISY response: {}&#39;</span>
                      <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>
            <span class="c1"># No action practical for this problem</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="c1"># Find the root node element</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;node&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">smsg</span><span class="p">(</span><span class="s1">&#39;**ERROR: probe: missing node element in response: {}&#39;</span>
                      <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>
            <span class="c1"># No action practical for this problem</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="c1"># Extract all the other fields we&#39;re interested in</span>
        <span class="n">n_def_id</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nodeDefId&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">n_flag</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;flag&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span>
        <span class="n">n_addr</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">findtext</span><span class="p">(</span><span class="s1">&#39;address&#39;</span><span class="p">)</span>
        <span class="n">n_name</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">findtext</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>
        <span class="n">n_pnode</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">findtext</span><span class="p">(</span><span class="s1">&#39;pnode&#39;</span><span class="p">)</span>
        <span class="n">n_enabled</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">findtext</span><span class="p">(</span><span class="s1">&#39;enabled&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smsg</span><span class="p">(</span><span class="s1">&#39;**INFO: probe: fa={} pfa={} id={} fl={} en={} nm=&quot;{}&quot;&#39;</span>
                  <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n_addr</span><span class="p">,</span> <span class="n">n_pnode</span><span class="p">,</span> <span class="n">n_def_id</span><span class="p">,</span> <span class="n">n_flag</span><span class="p">,</span>
                          <span class="n">n_enabled</span><span class="p">,</span> <span class="n">n_name</span><span class="p">))</span>

        <span class="c1"># Check that the fields match our node</span>

        <span class="n">pfx</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">poly</span><span class="o">.</span><span class="n">profile</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">full_addr</span> <span class="o">=</span> <span class="s1">&#39;n{}_{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pfx</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">full_addr</span> <span class="o">!=</span> <span class="n">n_addr</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">smsg</span><span class="p">(</span><span class="s1">&#39;**ERROR: probe: expected na=&quot;{}&quot;, response is for na=&quot;{}&quot;&#39;</span>
                      <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">full_addr</span><span class="p">,</span> <span class="n">n_addr</span><span class="p">))</span>
            <span class="c1"># No action practical for this problem</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">node_def_id</span> <span class="o">!=</span> <span class="n">n_def_id</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">smsg</span><span class="p">(</span><span class="s1">&#39;**ERROR: probe: expected id=&quot;{}&quot;, response is for id=&quot;{}&quot;&#39;</span>
                      <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">node_def_id</span><span class="p">,</span> <span class="n">n_def_id</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">smsg</span><span class="p">(</span><span class="s1">&#39;**ERROR: probe: setting local node state to &quot;not added&quot;&#39;</span><span class="p">)</span>
            <span class="n">node</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">node</span><span class="o">.</span><span class="n">added</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">return</span> <span class="bp">True</span>

        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">primary</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">primary_addr</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">primary</span><span class="o">.</span><span class="n">address</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">primary_addr</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">address</span>
        <span class="n">full_paddr</span> <span class="o">=</span> <span class="s1">&#39;n{}_{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pfx</span><span class="p">,</span> <span class="n">primary_addr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">full_paddr</span> <span class="o">!=</span> <span class="n">n_pnode</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">smsg</span><span class="p">(</span><span class="s1">&#39;**ERROR: probe: node parent mismatch, local: &quot;{}&quot; ISY: &quot;{}&quot;&#39;</span>
                      <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">full_paddr</span><span class="p">,</span> <span class="n">n_pnode</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">smsg</span><span class="p">(</span><span class="s1">&#39;**ERROR: probe: setting local node state to &quot;not added&quot;&#39;</span><span class="p">)</span>
            <span class="n">node</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">node</span><span class="o">.</span><span class="n">added</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">return</span> <span class="bp">True</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">added</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">smsg</span><span class="p">(</span><span class="s1">&#39;**WARNING: probe: node state mismatch - node is added on ISY&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">smsg</span><span class="p">(</span><span class="s1">&#39;**WARNING: probe: correcting local node state&#39;</span><span class="p">)</span>
            <span class="n">node</span><span class="o">.</span><span class="n">added</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">n_name</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">smsg</span><span class="p">(</span><span class="s1">&#39;**WARNING: probe: node name mismatch, local: &quot;{}&quot; ISY: &quot;{}&quot;&#39;</span>
                      <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">n_name</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">smsg</span><span class="p">(</span><span class="s1">&#39;**WARNING: probe: correcting local node name&#39;</span><span class="p">)</span>
            <span class="n">node</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">n_name</span><span class="p">;</span>

        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">enabled</span> <span class="o">!=</span> <span class="n">n_enabled</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">smsg</span><span class="p">(</span><span class="s1">&#39;**WARNING: probe: node enable mismatch, local:&quot;{}&quot; ISY:&quot;{}&quot;&#39;</span>
                      <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">enabled</span><span class="p">,</span> <span class="n">n_enabled</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">smsg</span><span class="p">(</span><span class="s1">&#39;**WARNING: probe: correcting local node state&#39;</span><span class="p">)</span>
            <span class="n">node</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="n">n_enabled</span><span class="p">;</span>

        <span class="k">return</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">restcall</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">api</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smsg</span><span class="p">(</span><span class="s1">&#39;**DEBUG: restcall: api=&quot;{}&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">api</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">SimpleNodeServer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">restcall</span><span class="p">(</span>
            <span class="n">api</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_rest_response</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_rest_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seq</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rest_response</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_save_rest_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">seq</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;seq&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rest_response</span><span class="p">[</span><span class="n">seq</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span>
        <span class="k">return</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">_add_node_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">na</span><span class="p">,</span> <span class="n">status_code</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">status_code</span><span class="p">)</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">na</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">na</span><span class="p">]</span><span class="o">.</span><span class="n">added</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">smsg</span><span class="p">(</span>
                    <span class="s1">&#39;**INFO: node &quot;{}&quot;: node successfully added on ISY&#39;</span>
                    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">na</span><span class="p">))</span>
                <span class="k">return</span> <span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">smsg</span><span class="p">(</span>
                    <span class="s1">&#39;**ERROR: node &quot;{}&quot;: node added on ISY, but no longer exists.&#39;</span>
                    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">na</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">smsg</span><span class="p">(</span>
                <span class="s1">&#39;**ERROR: node &quot;{}&quot;: node add REST call to ISY failed: {}&#39;</span>
                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">na</span><span class="p">,</span> <span class="n">status_code</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">_enable_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">):</span>
        <span class="c1"># Ensure the addressed node is enabled, and if the state changes</span>
        <span class="c1"># then force the configuration file update to record same</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">address</span><span class="p">]</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">address</span><span class="p">]</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">smsg</span><span class="p">(</span><span class="s1">&#39;**INFO: node &quot;{}&quot; enabled&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">address</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_config</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">probe_t</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">_disable_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">):</span>
        <span class="c1"># Ensure the addressed node is disabled - as above</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">address</span><span class="p">]</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">address</span><span class="p">]</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">smsg</span><span class="p">(</span><span class="s1">&#39;**INFO: node &quot;{}&quot; disabled&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">address</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_config</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">probe_t</span> <span class="o">=</span> <span class="mi">0</span>

<div class="viewcode-block" id="SimpleNodeServer.get_node"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.SimpleNodeServer.get_node">[docs]</a>    <span class="k">def</span> <span class="nf">get_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a node by its address.</span>

<span class="sd">        :param str address: The node address</span>
<span class="sd">        :returns polyglot.nodeserver_api.Node: If found, otherwise False</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">address</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">address</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="SimpleNodeServer.exist_node"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.SimpleNodeServer.exist_node">[docs]</a>    <span class="k">def</span> <span class="nf">exist_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if a node exists by its address.</span>

<span class="sd">        :param str address: The node address</span>
<span class="sd">        :returns bool: True if the node exists</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">address</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="SimpleNodeServer.update_config"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.SimpleNodeServer.update_config">[docs]</a>    <span class="k">def</span> <span class="nf">update_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">replace_manifest</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates the configuration with new node manifests and sends</span>
<span class="sd">        the configuration to Polyglot to be saved.</span>

<span class="sd">        :param boolean replace_manifest: replace or merge existing manifest</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">replace_manifest</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;manifest&#39;</span><span class="p">,</span> <span class="n">OrderedDict</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">node_addr</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">output</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">address</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">manifest</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;manifest&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">output</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">poly</span><span class="o">.</span><span class="n">send_config</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="SimpleNodeServer.on_enabled"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.SimpleNodeServer.on_enabled">[docs]</a>    <span class="k">def</span> <span class="nf">on_enabled</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_address</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Received node enabled report from ISY</span>

<span class="sd">        :param str node_address: The address of the node to act on</span>
<span class="sd">        :returns bool: True on success</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_enable_node</span><span class="p">(</span><span class="n">node_address</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="SimpleNodeServer.on_disabled"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.SimpleNodeServer.on_disabled">[docs]</a>    <span class="k">def</span> <span class="nf">on_disabled</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_address</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Received node disabled report from ISY</span>

<span class="sd">        :param str node_address: The address of the node to act on</span>
<span class="sd">        :returns bool: True on success</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_disable_node</span><span class="p">(</span><span class="n">node_address</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">True</span>
</div>
    <span class="nd">@auto_request_report</span>
<div class="viewcode-block" id="SimpleNodeServer.on_query"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.SimpleNodeServer.on_query">[docs]</a>    <span class="k">def</span> <span class="nf">on_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_address</span><span class="p">,</span> <span class="n">request_id</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Queries each node and reports all control values to the ISY. Also</span>
<span class="sd">        responds to report requests if necessary.</span>

<span class="sd">        :param str node_address: The address of the node to act on</span>
<span class="sd">        :param str optional request_id: Status request id</span>
<span class="sd">        :returns bool: True on success</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">node_address</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_enable_node</span><span class="p">(</span><span class="n">node_address</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node_address</span><span class="p">]</span><span class="o">.</span><span class="n">query</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">node_address</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">all</span><span class="p">([</span><span class="n">node</span><span class="o">.</span><span class="n">query</span><span class="p">()</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">smsg</span><span class="p">(</span><span class="s1">&#39;**ERROR: on_query: node &quot;{}&quot; does not exist&#39;</span>
                      <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">node_address</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">False</span>
</div>
    <span class="nd">@auto_request_report</span>
<div class="viewcode-block" id="SimpleNodeServer.on_status"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.SimpleNodeServer.on_status">[docs]</a>    <span class="k">def</span> <span class="nf">on_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_address</span><span class="p">,</span> <span class="n">request_id</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reports the requested node&#39;s control values to the ISY without forcing</span>
<span class="sd">        a query. Also sends requests reponses when necessary.</span>

<span class="sd">        :param str node_address: The address of the node to act on</span>
<span class="sd">        :param str optional request_id: Status request id</span>
<span class="sd">        :returns bool: True on success</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">node_address</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_enable_node</span><span class="p">(</span><span class="n">node_address</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node_address</span><span class="p">]</span><span class="o">.</span><span class="n">report_driver</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">node_address</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">all</span><span class="p">([</span><span class="n">node</span><span class="o">.</span><span class="n">report_driver</span><span class="p">()</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">smsg</span><span class="p">(</span><span class="s1">&#39;**ERROR: on_status: node &quot;{}&quot; does not exist&#39;</span>
                      <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">node_address</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">False</span>
</div>
    <span class="nd">@auto_request_report</span>
<div class="viewcode-block" id="SimpleNodeServer.on_add_all"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.SimpleNodeServer.on_add_all">[docs]</a>    <span class="k">def</span> <span class="nf">on_add_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request_id</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds all nodes to the ISY. Also sends requests reponses when necessary.</span>

<span class="sd">        :param str optional request_id: Status request id</span>
<span class="sd">        :returns bool: True on success</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">all_nodes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_nodes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">node</span><span class="o">.</span><span class="n">add_node</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="SimpleNodeServer.on_added"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.SimpleNodeServer.on_added">[docs]</a>    <span class="k">def</span> <span class="nf">on_added</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_address</span><span class="p">,</span> <span class="n">node_def_id</span><span class="p">,</span> <span class="n">primary_node_address</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Internally indicates that the specified node has been added to the ISY.</span>

<span class="sd">        :param str node_address: The address of the node to act on</span>
<span class="sd">        :param str node_def_id: The node definition id</span>
<span class="sd">        :param str primary_node_address: The node server&#39;s primary node address</span>
<span class="sd">        :param str name: The node&#39;s friendly name</span>
<span class="sd">        :param str optional request_id: Status request id</span>
<span class="sd">        :returns bool: True on success</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">node_address</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node_address</span><span class="p">]</span><span class="o">.</span><span class="n">added</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node_address</span><span class="p">]</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node_address</span><span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smsg</span><span class="p">(</span><span class="s1">&#39;**ERROR: on_added: node &quot;{}&quot; does not exist&#39;</span>
                  <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">node_address</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="SimpleNodeServer.on_removed"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.SimpleNodeServer.on_removed">[docs]</a>    <span class="k">def</span> <span class="nf">on_removed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_address</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Internally indicates that a node has been removed from the ISY.</span>

<span class="sd">        :param str node_address: The address of the node to act on</span>
<span class="sd">        :returns bool: True on success</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">node_address</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node_address</span><span class="p">]</span><span class="o">.</span><span class="n">added</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node_address</span><span class="p">]</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smsg</span><span class="p">(</span><span class="s1">&#39;**WARNING: on_removed: node &quot;{}&quot; does not exist&#39;</span>
                  <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">node_address</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="SimpleNodeServer.on_renamed"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.SimpleNodeServer.on_renamed">[docs]</a>    <span class="k">def</span> <span class="nf">on_renamed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_address</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Changes the node name internally to match the ISY.</span>

<span class="sd">        :param str node_address: The address of the node to act on</span>
<span class="sd">        :param str name: The node&#39;s friendly name</span>
<span class="sd">        :returns bool: True on success</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">node_address</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
            <span class="n">orig_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node_address</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node_address</span><span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">smsg</span><span class="p">(</span><span class="s1">&#39;**INFO: node &quot;{}&quot; renamed from &quot;{}&quot; to &quot;{}&quot;&#39;</span>
                      <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">node_address</span><span class="p">,</span> <span class="n">orig_name</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_enable_node</span><span class="p">(</span><span class="n">node_address</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smsg</span><span class="p">(</span><span class="s1">&#39;**ERROR: on_renamed: node &quot;{}&quot; does not exist&#39;</span>
                  <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">node_address</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">False</span>
</div>
    <span class="nd">@auto_request_report</span>
<div class="viewcode-block" id="SimpleNodeServer.on_cmd"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.SimpleNodeServer.on_cmd">[docs]</a>    <span class="k">def</span> <span class="nf">on_cmd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_address</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">uom</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
               <span class="n">request_id</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs the specified command on the specified node. Also sends requests</span>
<span class="sd">        reponses when necessary.</span>

<span class="sd">        :param str node_address: The address of the node to act on</span>
<span class="sd">        :param str command: The command to run</span>
<span class="sd">        :param optional value: The value of the command&#39;s unnamed parameter</span>
<span class="sd">        :param optional uom: The units of measurement for the unnamed parameter</span>
<span class="sd">        :param str optional request_id: Status request id</span>
<span class="sd">        :param optional &lt;pN&gt;.&lt;uomN&gt;: The value of parameter pN with units uomN</span>
<span class="sd">        :returns bool: True on success</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">node_address</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_enable_node</span><span class="p">(</span><span class="n">node_address</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node_address</span><span class="p">]</span><span class="o">.</span><span class="n">run_cmd</span><span class="p">(</span>
                <span class="n">command</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">cmd</span><span class="o">=</span><span class="n">command</span><span class="p">,</span> <span class="n">uom</span><span class="o">=</span><span class="n">uom</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smsg</span><span class="p">(</span><span class="s1">&#39;**ERROR: on_cmd: node &quot;{}&quot; does not exist for command &quot;{}&quot;&#39;</span>
                  <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">node_address</span><span class="p">,</span> <span class="n">command</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="SimpleNodeServer.on_exit"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.SimpleNodeServer.on_exit">[docs]</a>    <span class="k">def</span> <span class="nf">on_exit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Triggers a clean shut down of the node server by saving the manifest,</span>
<span class="sd">        clearing the IO, and stopping.</span>

<span class="sd">        :returns bool: True on success</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># save manifest</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_config</span><span class="p">()</span>

        <span class="c1"># cleanly close</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">True</span>

</div></div>
<div class="viewcode-block" id="PolyglotConnector"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.PolyglotConnector">[docs]</a><span class="k">class</span> <span class="nc">PolyglotConnector</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Polyglot API implementation. Connects to Polyglot and handles node server</span>
<span class="sd">    IO.</span>

<span class="sd">    :raises: RuntimeError</span>

<span class="sd">    .. decorated</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># pylint: disable=too-many-instance-attributes</span>

    <span class="n">commands</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">,</span> <span class="s1">&#39;install&#39;</span><span class="p">,</span> <span class="s1">&#39;query&#39;</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="s1">&#39;add_all&#39;</span><span class="p">,</span> <span class="s1">&#39;added&#39;</span><span class="p">,</span>
                <span class="s1">&#39;removed&#39;</span><span class="p">,</span> <span class="s1">&#39;renamed&#39;</span><span class="p">,</span> <span class="s1">&#39;enabled&#39;</span><span class="p">,</span> <span class="s1">&#39;disabled&#39;</span><span class="p">,</span> <span class="s1">&#39;cmd&#39;</span><span class="p">,</span> <span class="s1">&#39;ping&#39;</span><span class="p">,</span>
                <span class="s1">&#39;exit&#39;</span><span class="p">,</span> <span class="s1">&#39;params&#39;</span><span class="p">,</span> <span class="s1">&#39;result&#39;</span><span class="p">,</span> <span class="s1">&#39;statistics&#39;</span><span class="p">]</span>
    <span class="sd">&quot;&quot;&quot; Commands that may be invoked by Polyglot &quot;&quot;&quot;</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="bp">None</span>                
    <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">    logger is initialized after the node server wait_for_config completes</span>
<span class="sd">    by the setup_log method and the log file is located in the node servers</span>
<span class="sd">    sandbox.</span>
<span class="sd">    Once wait_for_config is complete, you can call</span>
<span class="sd">    `poly.logger.info(&#39;This variable is set to %s&#39;, variable)`</span>
<span class="sd">    &quot;&quot;&quot;</span>
       
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># make singleton</span>
        <span class="c1"># pylint: disable=global-statement</span>
        <span class="k">global</span> <span class="n">_POLYGLOT_CONNECTION</span>
        <span class="k">if</span> <span class="n">_POLYGLOT_CONNECTION</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;PolyglotConnector may only be created once.&#39;</span><span class="p">)</span>

        <span class="c1"># setup properties</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_outq</span> <span class="o">=</span> <span class="n">LockQueue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_errq</span> <span class="o">=</span> <span class="n">LockQueue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_handlers</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_threads</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_started</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_got_config</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">isyver</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sandbox</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">configfile</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodeserver_config</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">apiver</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">profile</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c1"># listen for important events</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="s1">&#39;ping&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pong</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="s1">&#39;config&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recv_config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="s1">&#39;params&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_params</span><span class="p">)</span>

        <span class="c1"># setup logging - redirect warnings and errors to stderr</span>
        <span class="n">fmt</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%(name)s</span><span class="s1">: </span><span class="si">%(message)s</span><span class="s1">&#39;</span>
        <span class="n">handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="n">handler</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>
        <span class="n">handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="n">fmt</span><span class="p">))</span>

        <span class="c1"># store connection globally in module</span>
        <span class="n">_POLYGLOT_CONNECTION</span> <span class="o">=</span> <span class="bp">self</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">uptime</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The number of sections the connection with Polyglot has been alive</span>

<span class="sd">        :type: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_started</span>

    <span class="c1"># manage connection</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">connected</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Indicates if the object is connected to Polyglot. Can be set to control</span>
<span class="sd">        connection with Polyglot.</span>

<span class="sd">        :type: boolean</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_threads</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;stdout&#39;</span><span class="p">)</span> \
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_threads</span><span class="p">[</span><span class="s1">&#39;stdout&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isAlive</span><span class="p">()</span>

    <span class="nd">@connected.setter</span>
    <span class="k">def</span> <span class="nf">connected</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Setter that connects object to Polyglot &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">val</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>

<div class="viewcode-block" id="PolyglotConnector.connect"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.PolyglotConnector.connect">[docs]</a>    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Connects to Polyglot if not currently connected &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_outq</span><span class="o">.</span><span class="n">locked</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_errq</span><span class="o">.</span><span class="n">locked</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_threads</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_threads</span><span class="p">[</span><span class="s1">&#39;stdin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">AsyncFileReader</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="p">,</span>
                                                     <span class="bp">self</span><span class="o">.</span><span class="n">_parse_cmd</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_threads</span><span class="p">[</span><span class="s1">&#39;stdout&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_send_out</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_threads</span><span class="p">[</span><span class="s1">&#39;stdout&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_threads</span><span class="p">[</span><span class="s1">&#39;stderr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_send_err</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_threads</span><span class="p">[</span><span class="s1">&#39;stderr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">thread</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_threads</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="PolyglotConnector.disconnect"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.PolyglotConnector.disconnect">[docs]</a>    <span class="k">def</span> <span class="nf">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Disconnects from Polyglot. Blocks the thread until IO stream is clear</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">connected</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_outq</span><span class="o">.</span><span class="n">locked</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_errq</span><span class="o">.</span><span class="n">locked</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_outq</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_errq</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_threads</span> <span class="o">=</span> <span class="p">{}</span>
</div>
<div class="viewcode-block" id="PolyglotConnector.wait_for_config"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.PolyglotConnector.wait_for_config">[docs]</a>    <span class="k">def</span> <span class="nf">wait_for_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Blocks the thread until the configuration is received &quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_got_config</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup_log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sandbox</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_read_nodeserver_config</span><span class="p">()</span>
</div>
    <span class="k">def</span> <span class="nf">_read_nodeserver_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Reads custom config file and presents it to node server as nodeserver_config </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">YAML</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">configfile</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">smsg</span><span class="p">(</span><span class="s1">&#39;**INFO: No custom &quot;configfile&quot; found in server.json. Trying the default of config.yaml.&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">configfile</span> <span class="o">=</span> <span class="s1">&#39;config.yaml&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">smsg</span><span class="p">(</span><span class="s1">&#39;**INFO: Custom config file option found in server.json: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">configfile</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">configfile</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">cfg</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">nodeserver_config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">smsg</span><span class="p">(</span><span class="s1">&#39;**INFO: {} - Config file loaded as dictionary to &quot;poly.nodeserver_config&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">configfile</span><span class="p">))</span>
            <span class="k">except</span> <span class="n">yaml</span><span class="o">.</span><span class="n">YAMLError</span><span class="p">,</span> <span class="n">exc</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="s1">&#39;problem_mark&#39;</span><span class="p">):</span>
                    <span class="n">mark</span> <span class="o">=</span> <span class="n">exc</span><span class="o">.</span><span class="n">problem_mark</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">smsg</span><span class="p">(</span><span class="s1">&#39;**ERROR: Error in config file. Position: (Line: {}: Column: {})&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mark</span><span class="o">.</span><span class="n">line</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">mark</span><span class="o">.</span><span class="n">column</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">smsg</span><span class="p">(</span><span class="s1">&#39;{} - &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exc</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">smsg</span><span class="p">(</span><span class="s1">&#39;**INFO: No config file found, or it is unreadable. This is normal if your nodeserver doesn</span><span class="se">\&#39;</span><span class="s1">t need a config file.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">smsg</span><span class="p">(</span><span class="s1">&#39;**ERROR: PyYAML module not installed... skipping custom config sections. &quot;sudo pip install pyyaml&quot; to use&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="PolyglotConnector.write_nodeserver_config"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.PolyglotConnector.write_nodeserver_config">[docs]</a>    <span class="k">def</span> <span class="nf">write_nodeserver_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">default_flow_style</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Writes any changes to the nodeserver custom configuration file. </span>
<span class="sd">        self.nodeserver_config should be a dictionary. Refrain from calling</span>
<span class="sd">        this in a poll of any kind. Typically you won&#39;t even have to write this</span>
<span class="sd">        unless you are storing custom data you want retrieved on the next </span>
<span class="sd">        run. Saved automatically during normal Polyglot shutdown. Returns </span>
<span class="sd">        True for success, False for failure.</span>
<span class="sd">        </span>
<span class="sd">        :param boolean default_flow_style: YAML&#39;s default flow style formatting. Default False</span>
<span class="sd">        :param int indent: Override the default indent spaces for YAML. Default 4</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">YAML</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">configfile</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">read</span><span class="p">:</span>
                    <span class="n">existing</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">read</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">existing</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodeserver_config</span><span class="p">:</span> 
                        <span class="bp">self</span><span class="o">.</span><span class="n">smsg</span><span class="p">(</span><span class="s1">&#39;**INFO: NodeServer configuration file matches running config... Skipping write.&#39;</span><span class="p">)</span>
                        <span class="k">return</span> <span class="bp">True</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">configfile</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">write</span><span class="p">:</span>
                    <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodeserver_config</span><span class="p">,</span> <span class="n">write</span><span class="p">,</span> <span class="n">default_flow_style</span><span class="o">=</span><span class="n">default_flow_style</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">smsg</span><span class="p">(</span><span class="s1">&#39;**INFO: NodeServer configuration file is different than running config... Updated file.&#39;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="bp">True</span>
            <span class="k">except</span> <span class="n">yaml</span><span class="o">.</span><span class="n">YAMLError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;**ERROR: write_nodeserver_config: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                <span class="k">return</span> <span class="bp">False</span>
            <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">smsg</span><span class="p">(</span><span class="s1">&#39;**ERROR: write_nodeserver_config: Could not write to nodeserver config file {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">configfile</span><span class="p">))</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">smsg</span><span class="p">(</span><span class="s1">&#39;**ERROR: PyYAML module not installed... skipping custom config sections. &quot;sudo pip install pyyaml&quot; to use&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">True</span>

    <span class="c1"># manage output</span></div>
    <span class="k">def</span> <span class="nf">_send_out</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Send output through pipe &quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_outq</span><span class="o">.</span><span class="n">locked</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_outq</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_outq</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">Empty</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_outq</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_send_err</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Send error through pipe &quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_errq</span><span class="o">.</span><span class="n">locked</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_errq</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_errq</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">Empty</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_errq</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

    <span class="c1"># manage input</span>
    <span class="k">def</span> <span class="nf">_parse_cmd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parses a received command.</span>

<span class="sd">        :param cmd: String command received from Polyglot</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1"># parse command</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_error</span><span class="p">(</span><span class="s1">&#39;Received badly formatted command &#39;</span> <span class="o">+</span>
                                <span class="s1">&#39;(not json): {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>
                <span class="k">return</span> <span class="bp">False</span>

            <span class="c1"># split command</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cmd_code</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">cmd</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">args</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="n">cmd_code</span><span class="p">]</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_error</span><span class="p">(</span><span class="s1">&#39;Received badly formatted command: {} &#39;</span>
                                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>
                <span class="k">return</span> <span class="bp">False</span>

            <span class="c1"># validate command</span>
            <span class="k">if</span> <span class="n">cmd_code</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">commands</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_error</span><span class="p">(</span><span class="s1">&#39;Received invalid command: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span>
                <span class="k">return</span> <span class="bp">False</span>

            <span class="c1"># execute command</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recv</span><span class="p">(</span><span class="n">cmd_code</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_recv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd_code</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handle command was received.</span>

<span class="sd">        :param cmd: The command that has been received</span>
<span class="sd">        :param data: Dictionary of received data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># pylint: disable=broad-except</span>
        <span class="n">success</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">fun</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handlers</span><span class="p">[</span><span class="n">cmd_code</span><span class="p">]:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">success</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fun</span><span class="p">(</span><span class="o">**</span><span class="n">data</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;--debug&#39;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">err</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">err_msg</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="n">fun_name</span> <span class="o">=</span> <span class="n">fun</span><span class="o">.</span><span class="n">__name__</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">send_error</span><span class="p">(</span><span class="s1">&#39;Error handling {} in function {}: {}&#39;</span>
                                    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cmd_code</span><span class="p">,</span> <span class="n">fun_name</span><span class="p">,</span> <span class="n">err_msg</span><span class="p">)</span> <span class="o">+</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">fun_name</span> <span class="o">=</span> <span class="n">fun</span><span class="o">.</span><span class="n">__name__</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">send_error</span><span class="p">(</span><span class="s1">&#39;Unsuccessful handling {} in function {}&#39;</span>
                                    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cmd_code</span><span class="p">,</span> <span class="n">fun_name</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">success</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_recv_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; note that the config has been received. &quot;&quot;&quot;</span>
        <span class="c1"># pylint: disable=unused-argument</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_got_config</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">True</span>

<div class="viewcode-block" id="PolyglotConnector.get_params"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.PolyglotConnector.get_params">[docs]</a>    <span class="k">def</span> <span class="nf">get_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the params from nodeserver and makes them available to</span>
<span class="sd">        the nodeserver api &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">isyver</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;isyver&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sandbox</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;sandbox&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pgver</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;pgver&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pgapiver</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;pgapiver&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">profile</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;profile&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">configfile</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;configfile&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">True</span>
</div>
    <span class="k">def</span> <span class="nf">setup_log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sandbox</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="c1"># Setup logger for individual nodeservers, log to</span>
        <span class="c1"># /config/&lt;nodeserver-name&gt;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_filename</span> <span class="o">=</span> <span class="n">sandbox</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;.log&quot;</span>
        <span class="c1"># Could be &quot;DEBUG&quot;, &quot;WARNING&quot;, or &quot;INFO&quot;</span>
        <span class="n">log_level</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">log_level</span><span class="p">)</span>
        <span class="c1"># Make a handler that writes to a file,</span>
        <span class="c1"># making a new file at midnight, and keeping 30 backups</span>
        <span class="n">handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">TimedRotatingFileHandler</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log_filename</span><span class="p">,</span> <span class="n">when</span><span class="o">=</span><span class="s2">&quot;midnight&quot;</span><span class="p">,</span> <span class="n">backupCount</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
        <span class="c1"># Format each log message like this</span>
        <span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span>
            <span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> </span><span class="si">%(levelname)-8s</span><span class="s1"> </span><span class="si">%(name)s</span><span class="s1"> </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1"># Attach the formatter to the handler</span>
        <span class="n">handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
        <span class="c1"># Attach the handler to the logger</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">logger</span>
       
    <span class="c1"># create output</span>
    <span class="k">def</span> <span class="nf">_mk_cmd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd_code</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Enqueue a command to be sent back to Polyglot.</span>

<span class="sd">        :param cmd_code: Command code</span>
<span class="sd">        :param args: arguments to send with command</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="n">cmd_code</span><span class="p">:</span> <span class="n">kwargs</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_outq</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

<div class="viewcode-block" id="PolyglotConnector.send_error"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.PolyglotConnector.send_error">[docs]</a>    <span class="k">def</span> <span class="nf">send_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">err_str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Enqueue an error to be sent back to Polyglot.</span>

<span class="sd">        :param str err_str: Error text to be sent to Polyglot log</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_errq</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">err_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="bp">True</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
        </div>
<div class="viewcode-block" id="PolyglotConnector.smsg"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.PolyglotConnector.smsg">[docs]</a>    <span class="k">def</span> <span class="nf">smsg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Logs/sends a diagnostic/debug, informative, or error message.</span>
<span class="sd">        Individual node servers can override this method if they desire to</span>
<span class="sd">        redirect or filter these messages.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_error</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="PolyglotConnector.send_config"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.PolyglotConnector.send_config">[docs]</a>    <span class="k">def</span> <span class="nf">send_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config_data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the configuration in Polyglot.</span>

<span class="sd">        :param dict config_data: Dictionary of updated configuration</span>
<span class="sd">        :raises: ValueError</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">config_data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mk_cmd</span><span class="p">(</span><span class="s1">&#39;config&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">config_data</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;send_config: config_data must be dictionary&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="PolyglotConnector.install"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.PolyglotConnector.install">[docs]</a>    <span class="k">def</span> <span class="nf">install</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Abstract method to install the node server in the ISY. This has not</span>
<span class="sd">        been implemented yet and running it will raise an error.</span>

<span class="sd">        :raises: NotImplementedError</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># [future] implement when documentation is available</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;install function has not been implemented&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="PolyglotConnector.report_status"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.PolyglotConnector.report_status">[docs]</a>    <span class="k">def</span> <span class="nf">report_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_address</span><span class="p">,</span> <span class="n">driver_control</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">uom</span><span class="p">,</span>
                      <span class="n">timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">seq</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates the ISY with the current value of a driver control (e.g. the</span>
<span class="sd">        current temperature, light level, etc.)</span>

<span class="sd">        :param  str node_address: The full address of the node (e.g.</span>
<span class="sd">                                  &#39;dimmer_1&#39;)</span>
<span class="sd">        :param str driver_control: The name of the status value (e.g. &#39;ST&#39;,</span>
<span class="sd">                                   &#39;CLIHUM&#39;, etc.)</span>
<span class="sd">        :param value: The numeric status value (e.g. &#39;80.5&#39;)</span>
<span class="sd">        :type value: str, float, or int</span>
<span class="sd">        :param uom: Unit of measure of the status value</span>
<span class="sd">        :type uom: int or str</span>
<span class="sd">        :param timeout: (optional) timeout (seconds) for REST call to ISY</span>
<span class="sd">        :type timeout: str, float, or int</span>
<span class="sd">        :param seq: (optional) set to unique id if result callback desired</span>
<span class="sd">        :type seq: str or int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mk_cmd</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="n">node_address</span><span class="o">=</span><span class="n">node_address</span><span class="p">,</span>
                     <span class="n">driver_control</span><span class="o">=</span><span class="n">driver_control</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">uom</span><span class="o">=</span><span class="n">uom</span><span class="p">,</span>
                     <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="n">seq</span><span class="o">=</span><span class="n">seq</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="PolyglotConnector.report_command"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.PolyglotConnector.report_command">[docs]</a>    <span class="k">def</span> <span class="nf">report_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_address</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">uom</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                       <span class="n">timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">seq</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sends a command to the ISY that may be used in programs and/or scenes.</span>
<span class="sd">        A common use of this is a physical switch that somebody turns on or</span>
<span class="sd">        off. Each time the switch is used, a command should be reported to the</span>
<span class="sd">        ISY. These are used for scenes and control conditions in ISY programs.</span>

<span class="sd">        :param str node_address: The full address of the node (e.g. &#39;switch_1)</span>
<span class="sd">        :param str command: The command to perform (e.g. &#39;DON&#39;, &#39;CLISPH&#39;, etc.)</span>
<span class="sd">        :param value: Optional unnamed value the command used</span>
<span class="sd">        :type value: str, int, or float</span>
<span class="sd">        :param uom: Optional units of measurement of value</span>
<span class="sd">        :type uom: int or str</span>
<span class="sd">        :param timeout: (optional) timeout (seconds) for REST call to ISY</span>
<span class="sd">        :type timeout: str, float, or int</span>
<span class="sd">        :param seq: (optional) set to unique id if result callback desired</span>
<span class="sd">        :type seq: str or int</span>
<span class="sd">        :param optional &lt;pN&gt;.&lt;uomN&gt;: Nth Parameter name (e.g. &#39;level&#39;) . Unit</span>
<span class="sd">                                     of measure of the Nth parameter</span>
<span class="sd">                                     (e.g. &#39;seconds&#39;, &#39;uom58&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;node_address&#39;</span><span class="p">:</span> <span class="n">node_address</span><span class="p">,</span> <span class="s1">&#39;command&#39;</span><span class="p">:</span> <span class="n">command</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">if</span> <span class="n">uom</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;uom&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">uom</span>
        <span class="k">if</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;timeout&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">timeout</span>
        <span class="k">if</span> <span class="n">seq</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;seq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">seq</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mk_cmd</span><span class="p">(</span><span class="s1">&#39;command&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="PolyglotConnector.add_node"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.PolyglotConnector.add_node">[docs]</a>    <span class="k">def</span> <span class="nf">add_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_address</span><span class="p">,</span> <span class="n">node_def_id</span><span class="p">,</span> <span class="n">primary</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
                 <span class="n">timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">seq</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds a node to the ISY. To make this node the primary, set primary to</span>
<span class="sd">        the same value as node_address.</span>

<span class="sd">        :param str node_address: The full address of the node (e.g.</span>
<span class="sd">                                 &#39;dimmer_1&#39;)</span>
<span class="sd">        :param str node_def_id: The id of the node definition to use for this</span>
<span class="sd">                                node</span>
<span class="sd">        :param str primary: The primary node for the device this node</span>
<span class="sd">                            belongs to</span>
<span class="sd">        :param str name: The name of the node</span>
<span class="sd">        :param timeout: (optional) timeout (seconds) for REST call to ISY</span>
<span class="sd">        :type timeout: str, float, or int</span>
<span class="sd">        :param seq: (optional) set to unique id if result callback desired</span>
<span class="sd">        :type seq: str or int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;node_address&#39;</span><span class="p">:</span> <span class="n">node_address</span><span class="p">,</span> <span class="s1">&#39;node_def_id&#39;</span><span class="p">:</span> <span class="n">node_def_id</span><span class="p">,</span>
                <span class="s1">&#39;primary&#39;</span><span class="p">:</span> <span class="n">primary</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">args</span><span class="p">[</span><span class="s1">&#39;timeout&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">timeout</span>
        <span class="k">if</span> <span class="n">seq</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">args</span><span class="p">[</span><span class="s1">&#39;seq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">seq</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mk_cmd</span><span class="p">(</span><span class="s1">&#39;add&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="PolyglotConnector.change_node"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.PolyglotConnector.change_node">[docs]</a>    <span class="k">def</span> <span class="nf">change_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_address</span><span class="p">,</span> <span class="n">node_def_id</span><span class="p">,</span>
                    <span class="n">timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">seq</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Changes the node definition to use for an existing node. An example of</span>
<span class="sd">        this is may be to change a thermostat node from Fahrenheit to Celsius.</span>

<span class="sd">        :param str node_address: The full address of the node (e.g.</span>
<span class="sd">                                 &#39;dimmer_1&#39;)</span>
<span class="sd">        :param str node_def_id: The id of the node definition to use for this</span>
<span class="sd">                                node</span>
<span class="sd">        :param timeout: (optional) timeout (seconds) for REST call to ISY</span>
<span class="sd">        :type timeout: str, float, or int</span>
<span class="sd">        :param seq: (optional) set to unique id if result callback desired</span>
<span class="sd">        :type seq: str or int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mk_cmd</span><span class="p">(</span><span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="n">node_address</span><span class="o">=</span><span class="n">node_address</span><span class="p">,</span>
                     <span class="n">node_def_id</span><span class="o">=</span><span class="n">node_def_id</span><span class="p">,</span>
                     <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="n">seq</span><span class="o">=</span><span class="n">seq</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="PolyglotConnector.remove_node"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.PolyglotConnector.remove_node">[docs]</a>    <span class="k">def</span> <span class="nf">remove_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_address</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">seq</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Removes a node from the ISY. A node cannot be removed if it is the</span>
<span class="sd">        primary node for at least one other node.</span>

<span class="sd">        :param str node_address: The full address of the node (e.g.</span>
<span class="sd">                                 &#39;dimmer_1&#39;)</span>
<span class="sd">        :param timeout: (optional) timeout (seconds) for REST call to ISY</span>
<span class="sd">        :type timeout: str, float, or int</span>
<span class="sd">        :param seq: (optional) set to unique id if result callback desired</span>
<span class="sd">        :type seq: str or int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mk_cmd</span><span class="p">(</span><span class="s1">&#39;remove&#39;</span><span class="p">,</span> <span class="n">node_address</span><span class="o">=</span><span class="n">node_address</span><span class="p">,</span>
                     <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="n">seq</span><span class="o">=</span><span class="n">seq</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="PolyglotConnector.report_request_status"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.PolyglotConnector.report_request_status">[docs]</a>    <span class="k">def</span> <span class="nf">report_request_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">success</span><span class="p">,</span>
                              <span class="n">timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">seq</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        When the ISY sends a request to the node server, the request may</span>
<span class="sd">        contain a &#39;requestId&#39; field. This indicates to the node server that</span>
<span class="sd">        when the request is completed, it must send a fail or success report</span>
<span class="sd">        for that request. This allows the ISY to in effect, have the node</span>
<span class="sd">        server synchronously perform tasks. This message must be sent after all</span>
<span class="sd">        other messages related to the task have been sent.</span>

<span class="sd">        For example, if the ISY sends a request to query a node, all the</span>
<span class="sd">        results of the query must be sent to the ISY before a fail/success</span>
<span class="sd">        report is sent.</span>

<span class="sd">        :param str request_id: The request ID the ISY supplied on a request to</span>
<span class="sd">                               the node server.</span>
<span class="sd">        :param bool success: Indicates if the request was sucessful</span>
<span class="sd">        :param timeout: (optional) timeout (seconds) for REST call to ISY</span>
<span class="sd">        :type timeout: str, float, or int</span>
<span class="sd">        :param seq: (optional) set to unique id if result callback desired</span>
<span class="sd">        :type seq: str or int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mk_cmd</span><span class="p">(</span><span class="s1">&#39;request&#39;</span><span class="p">,</span> <span class="n">request_id</span><span class="o">=</span><span class="n">request_id</span><span class="p">,</span> <span class="n">success</span><span class="o">=</span><span class="n">success</span><span class="p">,</span>
                     <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="n">seq</span><span class="o">=</span><span class="n">seq</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="PolyglotConnector.restcall"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.PolyglotConnector.restcall">[docs]</a>    <span class="k">def</span> <span class="nf">restcall</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">api</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">seq</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calls a RESTful api on the ISY.  The api is the portion of</span>
<span class="sd">        the url after the &quot;https://isy/rest/&quot; prefix.</span>

<span class="sd">        :param str api: The url for the api to call</span>
<span class="sd">        :param timeout: (optional) timeout (seconds) for REST call to ISY</span>
<span class="sd">        :type timeout: str, float, or int</span>
<span class="sd">        :param seq: (optional) set to unique id if result callback desired</span>
<span class="sd">        :type seq: str or int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mk_cmd</span><span class="p">(</span><span class="s1">&#39;restcall&#39;</span><span class="p">,</span> <span class="n">api</span><span class="o">=</span><span class="n">api</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span> <span class="n">seq</span><span class="o">=</span><span class="n">seq</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="PolyglotConnector.pong"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.PolyglotConnector.pong">[docs]</a>    <span class="k">def</span> <span class="nf">pong</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sends pong reply to Polyglot&#39;s ping request. This verifies that the</span>
<span class="sd">        communication between the Node Server and Polyglot is functioning.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># pylint: disable=unused-argument</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mk_cmd</span><span class="p">(</span><span class="s1">&#39;pong&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">True</span>
        </div>
<div class="viewcode-block" id="PolyglotConnector.request_stats"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.PolyglotConnector.request_stats">[docs]</a>    <span class="k">def</span> <span class="nf">request_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sends a command to Polyglot to request a statistics message.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># pylint: disable=unused-argument</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mk_cmd</span><span class="p">(</span><span class="s1">&#39;statistics&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="PolyglotConnector.exit"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.PolyglotConnector.exit">[docs]</a>    <span class="k">def</span> <span class="nf">exit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Tells Polyglot that this Node Server is done.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># pylint: disable=unused-argument</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_nodeserver_config</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mk_cmd</span><span class="p">(</span><span class="s1">&#39;exit&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">True</span>

    <span class="c1"># manage handlers</span></div>
<div class="viewcode-block" id="PolyglotConnector.listen"><a class="viewcode-back" href="../../nsdev.html#polyglot.nodeserver_api.PolyglotConnector.listen">[docs]</a>    <span class="k">def</span> <span class="nf">listen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">handler</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Register an event handler. Returns True on success. Event names are</span>
<span class="sd">        defined in `commands`. Handlers must be callable.</span>

<span class="sd">        :param str event: Then event name to listen for.</span>
<span class="sd">        :param callable handler: The callable event handler.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">event</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">commands</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="n">handler</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_handlers</span><span class="p">[</span><span class="n">event</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">True</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, Universal Devices Inc..

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'0.0.6',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>